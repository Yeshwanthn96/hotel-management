<div class="container">
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h2 class="card-title" style="margin: 0; border: none;">
          üí¨ {{ authService.isAdmin() ? 'Review Conversations' : 'My Review Conversations' }}
        </h2>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
          {{ authService.isAdmin() ? 'View and respond to customer reviews' : 'Your conversations with hotels about your stays' }}
        </p>
      </div>
      <button *ngIf="!authService.isAdmin()" routerLink="/reviews/add" class="btn btn-primary">+ Write Review</button>
    </div>
    
    <div *ngIf="reviews && reviews.length > 0; else emptyState">
      <!-- Group reviews by hotel -->
      <div *ngFor="let hotelId of getHotelIds()" style="margin-bottom: 30px;">
        <!-- Hotel Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin-bottom: 0;">
          <h3 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
            üè® {{ getHotelName(hotelId) }}
            <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: normal;">
              {{ groupedReviews.get(hotelId)?.length }} conversation{{ groupedReviews.get(hotelId)?.length === 1 ? '' : 's' }}
            </span>
          </h3>
        </div>

        <!-- Chat-style conversations for this hotel (Scrollable) -->
        <div style="border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: #f9f9f9; max-height: 600px; overflow-y: auto;">
          <div *ngFor="let review of groupedReviews.get(hotelId)" style="margin-bottom: 24px;">
            
            <!-- Chat Container -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
              
              <!-- User's Initial Review Message (Left-aligned chat bubble) -->
              <div style="padding: 15px; background: #f5f7fa;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                  <div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    üë§
                  </div>
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                      <strong style="color: #333; font-size: 14px;">{{ review.userName || getUserName(review.userId) }}</strong>
                      <span *ngIf="review.verified" style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">‚úì Verified</span>
                      <span style="font-size: 11px; color: #999; margin-left: auto;">{{ review.createdAt | date:'short' }}</span>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                      <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                        <div style="font-size: 14px;">{{ getStars(review.rating) }}</div>
                        <h4 *ngIf="review.title" style="margin: 0; color: #333; font-size: 13px; font-weight: 600;">{{ review.title }}</h4>
                      </div>
                      <p style="margin: 0; color: #444; line-height: 1.5; font-size: 13px;">{{ review.comment }}</p>
                      <!-- User Actions -->
                      <div *ngIf="!authService.isAdmin() && canEditReview(review)" style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                        <button (click)="openEditModal(review)" style="background: transparent; border: 1px solid #667eea; color: #667eea; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 3px;">
                          <span style="font-size: 10px;">‚úèÔ∏è</span> Edit
                        </button>
                        <button (click)="deleteReview(review)" style="background: transparent; border: 1px solid #dc3545; color: #dc3545; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 3px;">
                          <span style="font-size: 10px;">üóë</span> Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Hotel's Reply (Right-aligned chat bubble) -->
              <div *ngIf="review.adminReply" style="padding: 15px; background: #fff;">
                <div style="display: flex; align-items: flex-start; gap: 10px; flex-direction: row-reverse;">
                  <div style="background: #4caf50; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    üè®
                  </div>
                  <div style="flex: 1; text-align: right;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; justify-content: flex-end;">
                      <span style="font-size: 11px; color: #999;">{{ review.updatedAt ? (review.updatedAt | date:'short') : (review.createdAt | date:'short') }}</span>
                      <strong style="color: #2e7d32; font-size: 14px;">{{ getHotelName(hotelId) }}</strong>
                    </div>
                    <div style="background: #e8f5e9; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(76,175,80,0.2); text-align: left;">
                      <p style="margin: 0; color: #333; line-height: 1.5; font-size: 13px;">{{ review.adminReply }}</p>
                      <!-- Admin Actions -->
                      <div *ngIf="authService.isAdmin()" style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(46,125,50,0.1); justify-content: flex-end;">
                        <button (click)="openAdminReplyModal(review)" style="background: transparent; border: 1px solid #4caf50; color: #4caf50; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 3px;">
                          <span style="font-size: 10px;">‚úèÔ∏è</span> Edit
                        </button>
                      </div>
                      <!-- User can continue conversation -->
                      <div *ngIf="!authService.isAdmin() && !review.userReply" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(46,125,50,0.1);">
                        <button (click)="openReplyModal(review)" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                          <span style="font-size: 11px;">üí¨</span> Reply
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- User's Reply (Left-aligned chat bubble) -->
              <div *ngIf="review.userReply" style="padding: 15px; background: #f5f7fa;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                  <div style="background: #2196f3; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    üë§
                  </div>
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                      <strong style="color: #333; font-size: 14px;">{{ review.userName || getUserName(review.userId) }}</strong>
                      <span style="font-size: 11px; color: #999; margin-left: auto;">{{ review.updatedAt | date:'short' }}</span>
                    </div>
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(33,150,243,0.2);">
                      <p style="margin: 0; color: #333; line-height: 1.5; font-size: 13px;">{{ review.userReply }}</p>
                      <!-- User can edit their reply -->
                      <div *ngIf="!authService.isAdmin()" style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(33,150,243,0.1);">
                        <button (click)="openEditUserReplyModal(review)" style="background: transparent; border: 1px solid #2196f3; color: #2196f3; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 3px;">
                          <span style="font-size: 10px;">‚úèÔ∏è</span> Edit
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Admin can delete entire conversation or reply if no hotel reply yet -->
              <div *ngIf="authService.isAdmin()" style="padding: 12px 15px; background: #fafafa; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 8px;">
                <button *ngIf="!review.adminReply" (click)="openAdminReplyModal(review)" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 11px;">üí¨</span> Reply as Hotel
                </button>
                <button (click)="deleteReview(review)" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 11px;">üóë</span> Delete
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template #emptyState>
      <div class="empty-state">
        <h3>{{ authService.isAdmin() ? 'No Reviews in System' : 'No Reviews Yet' }}</h3>
        <p *ngIf="authService.isAdmin()">No customer reviews have been submitted yet</p>
        <p *ngIf="!authService.isAdmin()">You haven't written any reviews yet. Share your experience after your stays!</p>
        <button *ngIf="!authService.isAdmin()" routerLink="/reviews/add" class="btn btn-primary" style="margin-top: 15px;">Write Your First Review</button>
      </div>
    </ng-template>
  </div>
</div>

<!-- User Reply Modal -->
<div *ngIf="showReplyModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%;">
    <h3 style="margin: 0 0 15px 0;">Reply to Hotel Response</h3>
    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">The hotel will be notified of your reply.</p>
    <textarea [(ngModel)]="userReply" placeholder="Write your reply..." 
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-height: 100px; font-size: 14px; resize: vertical;"></textarea>
    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
      <button (click)="closeReplyModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button (click)="submitUserReply()" [disabled]="!userReply.trim()" class="btn btn-primary" style="padding: 10px 20px;">Send Reply</button>
    </div>
  </div>
</div>

<!-- Admin Reply Modal -->
<div *ngIf="showAdminReplyModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 25px; border-radius: 12px; max-width: 600px; width: 90%;">
    <h3 style="margin: 0 0 15px 0;">üè® Respond to Review</h3>
    
    <!-- Review Summary -->
    <div *ngIf="selectedReview" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <strong>{{ selectedReview.title }}</strong>
          <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">by {{ selectedReview.userName || 'Anonymous' }}</p>
        </div>
        <span style="font-size: 16px;">{{ getStars(selectedReview.rating) }}</span>
      </div>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: #444;">{{ selectedReview.comment }}</p>
    </div>
    
    <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Your Response:</label>
    <textarea [(ngModel)]="adminReply" placeholder="Write a professional response to this customer review..." 
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-height: 120px; font-size: 14px; resize: vertical;"></textarea>
    <p style="font-size: 12px; color: #888; margin: 8px 0 0 0;">This response will be visible to all users viewing this review.</p>
    
    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
      <button (click)="closeAdminReplyModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button (click)="submitAdminReply()" [disabled]="!adminReply.trim()" class="btn btn-primary" style="padding: 10px 20px;">
        {{ selectedReview?.adminReply ? 'Update Response' : 'Post Response' }}
      </button>
    </div>
  </div>
</div>

<!-- Edit Review Modal (User) -->
<div *ngIf="showEditModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 25px; border-radius: 12px; max-width: 600px; width: 90%;">
    <h3 style="margin: 0 0 15px 0;">‚úèÔ∏è Edit Your Review</h3>
    
    <!-- Review Summary -->
    <div *ngIf="selectedReview" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      <strong>{{ getHotelName(selectedReview.hotelId) }}</strong>
    </div>
    
    <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Rating:</label>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <button *ngFor="let star of [1,2,3,4,5]" 
              (click)="editRating = star"
              [style.background]="star <= editRating ? '#ffa500' : '#e0e0e0'"
              style="border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 18px;">
        ‚≠ê
      </button>
    </div>
    
    <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Your Review:</label>
    <textarea [(ngModel)]="editComment" placeholder="Share your experience..." 
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-height: 120px; font-size: 14px; resize: vertical;"></textarea>
    
    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
      <button (click)="closeEditModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button (click)="submitEditReview()" [disabled]="!editComment.trim()" class="btn btn-primary" style="padding: 10px 20px;">
        Update Review
      </button>
    </div>
  </div>
</div>

<!-- Edit User Reply Modal -->
<div *ngIf="showEditUserReplyModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%;">
    <h3 style="margin: 0 0 15px 0;">‚úèÔ∏è Edit Your Reply</h3>
    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Update your response to the hotel's reply.</p>
    <textarea [(ngModel)]="editUserReply" placeholder="Write your reply..." 
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-height: 100px; font-size: 14px; resize: vertical;"></textarea>
    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
      <button (click)="closeEditUserReplyModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button (click)="submitEditUserReply()" [disabled]="!editUserReply.trim()" class="btn btn-primary" style="padding: 10px 20px;">Update Reply</button>
    </div>
  </div>
</div>
