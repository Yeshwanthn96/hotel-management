<div class="notification-management-container">
  <div class="header">
    <h1>Notification Management</h1>
    <button class="btn btn-primary" (click)="openSendModal()">
      ğŸ“¤ Send Notification
    </button>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="error && !showSendModal" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Info Card -->
  <div class="info-card">
    <div class="info-content">
      <h3>ğŸ“¨ Send Notifications to Users</h3>
      <p>Use this panel to send notifications to all users, specific users, or groups. You can choose to send immediately or schedule for later.</p>
      <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
        <li><strong>All Users:</strong> Send to everyone registered in the system</li>
        <li><strong>Specific Users:</strong> Select individual users from the list</li>
        <li><strong>Upcoming Bookings:</strong> Target users with reservations in the next 7 days</li>
      </ul>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon email">ğŸ“§</div>
      <div class="stat-content">
        <h3>Email Channel</h3>
        <p>Primary notification method</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon sms">ğŸ“±</div>
      <div class="stat-content">
        <h3>SMS Channel</h3>
        <p>For urgent notifications</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon app">ğŸ””</div>
      <div class="stat-content">
        <h3>In-App Notifications</h3>
        <p>User dashboard alerts</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon users">ğŸ‘¥</div>
      <div class="stat-content">
        <h3>{{ users.length }} Users</h3>
        <p>Total registered users</p>
      </div>
    </div>
  </div>

  <!-- Send Modal -->
  <div class="modal-overlay" *ngIf="showSendModal" (click)="closeSendModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Send Notification</h2>
        <button class="close-btn" (click)="closeSendModal()">&times;</button>
      </div>

      <form [formGroup]="sendForm" class="notification-form">
        <div class="form-section">
          <h3>ğŸ‘¥ Recipients</h3>
          
          <div class="form-group">
            <label>Recipient Type *</label>
            <select formControlName="recipientType">
              <option *ngFor="let type of recipientTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
          </div>

          <!-- User Selection for Specific Users -->
          <div class="form-group" *ngIf="sendForm.get('recipientType')?.value === 'SPECIFIC'">
            <label>Select Users * ({{ selectedUserIds.length }} selected)</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button type="button" class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;" (click)="selectAllUsers()">Select All</button>
              <button type="button" class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;" (click)="clearUserSelection()">Clear</button>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
              <label *ngFor="let user of users" 
                     style="display: flex; align-items: center; padding: 8px; margin: 2px 0; background: #f9f9f9; border-radius: 4px; cursor: pointer;"
                     [style.background]="isUserSelected(user.id) ? '#e3f2fd' : '#f9f9f9'">
                <input type="checkbox" 
                       [checked]="isUserSelected(user.id)" 
                       (change)="toggleUserSelection(user.id)"
                       style="margin-right: 10px;">
                <div>
                  <strong>{{ user.firstName }} {{ user.lastName }}</strong>
                  <br><small style="color: #666;">{{ user.email }}</small>
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Notification Type *</label>
            <select formControlName="notificationType">
              <option *ngFor="let type of notificationTypes" [value]="type">
                {{ type.replace('_', ' ') }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h3>âœ‰ï¸ Message Content</h3>
          
          <div class="form-group">
            <label>Subject *</label>
            <input type="text" formControlName="subject" placeholder="Enter notification subject">
          </div>

          <div class="form-group">
            <label>Message *</label>
            <textarea formControlName="message" rows="5" placeholder="Enter your message here..."></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3>ğŸ“¡ Delivery Channels</h3>
          
          <div class="channels-group" formGroupName="channels">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="email">
              <span class="checkbox-text">ğŸ“§ Email</span>
            </label>

            <label class="checkbox-label">
              <input type="checkbox" formControlName="sms">
              <span class="checkbox-text">ğŸ“± SMS</span>
            </label>

            <label class="checkbox-label">
              <input type="checkbox" formControlName="inApp">
              <span class="checkbox-text">ğŸ”” In-App Notification</span>
            </label>
          </div>

          <p class="channel-info" *ngIf="getChannelsSelected() === 0" style="color: #f44336;">
            âš ï¸ Please select at least one delivery channel
          </p>
        </div>

        <div class="form-section">
          <h3>â° Schedule</h3>
          
          <div class="schedule-options">
            <label class="radio-label">
              <input type="radio" formControlName="scheduleNow" [value]="true">
              <span class="radio-text">Send Immediately</span>
            </label>

            <label class="radio-label">
              <input type="radio" formControlName="scheduleNow" [value]="false">
              <span class="radio-text">Schedule for Later</span>
            </label>
          </div>

          <div class="schedule-datetime" *ngIf="!sendForm.get('scheduleNow')?.value" style="display: flex; gap: 15px; margin-top: 15px;">
            <div class="form-group" style="flex: 1;">
              <label>Date</label>
              <input type="date" formControlName="scheduleDate">
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Time</label>
              <input type="time" formControlName="scheduleTime">
            </div>
          </div>
        </div>

        <div *ngIf="error" class="alert alert-error">
          {{ error }}
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeSendModal()">
            Cancel
          </button>
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="sendNotification()" 
            [disabled]="loading || sendForm.invalid || getChannelsSelected() === 0">
            {{ loading ? 'Sending...' : (sendForm.get('scheduleNow')?.value ? 'ğŸ“¤ Send Now' : 'ğŸ“… Schedule Notification') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
